var G_WS_SERVER_URI="ws://localhost:8100";var G_WS_SERVER_ID="WsServer";var G_WS_SERVER_STAMP=0;var G_WS=null;var G_WATCHDOG_TM=60;var G_WATCHDOG_TIMER=0;var G_WATCHDOG_DATA_STAMP=0;var G_WATCHDOG_DATA_LOGGED=false;var G_WATCHDOG_CONN_LOGGED=false;var G_POPUP_BASIC=null;var G_RES={en:{},ru:{}};var G_LANG="ru";var G_FORM_SET=null;var G_HMI=null;var G_DEBUG=false;var G_FIELD__ID="ID";var G_FIELD__STAMP="Stamp";var G_FIELD__NETWORKS="Networks";var G_FIELD__DEVICES="Devices";var G_FIELD__DEVICE_ADDR="BaseAddr";var G_LOG=null;var G_LOG_LIM_ROWS=100;var G_DEVICE_ADDR=0;function getWsServerState(){if(G_WS!=null){if(G_WS.readyState>=0||G_WS.readyState<4){return(G_WS.readyState)}}return(4)}function hasWsServerOpened(){var a=getWsServerState();return((a==1)?true:false)}function refreshWsServerDesc(){var a=getWsServerState();var b=null;b=$("#WsServerID");if(b){b.text(G_WS_SERVER_ID)}b=$("#WsServerUri");if(b){b.text(G_WS_SERVER_URI);b.attr("title",G_WS_SERVER_URI)}b=$("#WsServerState");if(b){b.text(G_RES[G_LANG]["ConnStates"][a])}var d=[$("#FormSetConnect"),$("#ConnectState")];for(var c=0;c<d.length;c++){if(d[c]){d[c].removeClass("ui-icon-disconnected");d[c].removeClass("ui-icon-connected");d[c].addClass(((a==1)?"ui-icon-connected":"ui-icon-disconnected"));d[c].text(((a==1)?G_RES[G_LANG]["Disconnect"]:G_RES[G_LANG]["Connect"]));d[c].attr("title",((a==1)?G_RES[G_LANG]["Disconnect"]:G_RES[G_LANG]["Connect"]))}}}function refreshHMI(a){if(a&&G_HMI){G_HMI.refresh(a)}}function closeWsServer(){if(G_WS){G_WS.close()}}function onWindowBeforeUnload(a){closeWsServer();return(null)}function onWebSocketOpened(a){G_WATCHDOG_DATA_LOGGED=false;G_WATCHDOG_CONN_LOGGED=false;G_LOG.add(null,G_RES[G_LANG]["WebSocket"],G_RES[G_LANG]["Connected"],null);printDebug(G_DEBUG,"CONNECTED");refreshWsServerDesc()}function onWebSocketClosed(a){if(!G_WATCHDOG_CONN_LOGGED){G_LOG.add(null,G_RES[G_LANG]["WebSocket"],G_RES[G_LANG]["Disconnected"],null);printDebug(G_DEBUG,"DISCONNECTED")}refreshWsServerDesc()}function isAnswerNet(a){if(typeof a=="object"&&typeof is_array=="function"){if(a){if(typeof a[G_FIELD__ID]=="string"&&typeof a[G_FIELD__STAMP]=="number"&&typeof a[G_FIELD__NETWORKS]=="object"){if(a[G_FIELD__ID]==G_WS_SERVER_ID){return(is_array(a[G_FIELD__NETWORKS]))}}}}return(false)}function isAnswerNetDev(a){if(typeof a=="object"&&typeof is_array=="function"){if(a){if(typeof a[G_FIELD__DEVICES]=="object"){return(is_array(a[G_FIELD__DEVICES]))}}}return(false)}function isAnswerNetDevAddr(a,b){if(typeof a=="object"){if(a){if(typeof a[G_FIELD__DEVICE_ADDR]=="number"){return(a[G_FIELD__DEVICE_ADDR]==b)}}}return(false)}function onWebSocketMsgReceived(d){var c=JSON.parse(d.data);printDebug(G_DEBUG,"MESSAGE: "+d.data);if(isAnswerNet(c)){G_WS_SERVER_STAMP=c[G_FIELD__STAMP];G_WATCHDOG_DATA_LOGGED=false;var b=0,a=0;for(b=0;b<c[G_FIELD__NETWORKS].length;b++){if(isAnswerNetDev(c[G_FIELD__NETWORKS][b])){printDebug(G_DEBUG,c[G_FIELD__NETWORKS][b]);for(a=0;a<c[G_FIELD__NETWORKS][b][G_FIELD__DEVICES].length;a++){if(G_DEVICE_ADDR>0){if(!isAnswerNetDevAddr(c[G_FIELD__NETWORKS][b][G_FIELD__DEVICES][a],G_DEVICE_ADDR)){continue}}printDebug(G_DEBUG,c[G_FIELD__NETWORKS][b][G_FIELD__DEVICES][a]);refreshHMI(c[G_FIELD__NETWORKS][b][G_FIELD__DEVICES][a])}}}}}function onWebSocketErrReceived(b){if(!G_WATCHDOG_CONN_LOGGED){var a=G_RES[G_LANG]["SrvConnErr"].replace(/\{0\}/g,G_WS_SERVER_URI);printDebug(G_DEBUG,a);G_LOG.add(null,G_RES[G_LANG]["WebSocket"],a,"yellow");if(!G_LOG.isCaseVisible()){G_POPUP_BASIC.showBasic(a)}}}function openWsServer(){try{if(typeof MozWebSocket=="function"){WebSocket=MozWebSocket}if(G_WS&&G_WS.readyState==1){G_WS.close()}if(!G_WS){window.onbeforeunload=onWindowBeforeUnload}if(typeof WebSocket!="undefined"){G_WS=new WebSocket(G_WS_SERVER_URI);G_WS.onopen=onWebSocketOpened;G_WS.onclose=onWebSocketClosed;G_WS.onmessage=onWebSocketMsgReceived;G_WS.onerror=onWebSocketErrReceived}else{printDebug(G_DEBUG,"Error! Websocket is not supported in your browser!");G_LOG.add(null,G_RES[G_LANG]["WebSocket"],G_RES[G_LANG]["WsNotSupportErr"],null);if(!G_LOG.isCaseVisible()){G_POPUP_BASIC.showBasic(G_RES[G_LANG]["WsNotSupportErr"])}}}catch(a){printDebug(G_DEBUG,"Exception! "+a);G_LOG.add(null,G_RES[G_LANG]["WebSocket"],"Exception! "+a,null);if(!G_LOG.isCaseVisible()){G_POPUP_BASIC.showBasic("Exception! "+a)}}}function onFormSetConnectClicked(b){var a=getWsServerState();G_WATCHDOG_DATA_LOGGED=false;G_WATCHDOG_CONN_LOGGED=false;if(a==0||a==1){closeWsServer()}else{openWsServer()}}function onFormSetLogClicked(c){var a=G_FORM_SET.getResultset();if(a){var b=((typeof a.log_use=="number")?true:false);G_LOG.toggleCase(b)}}function onWatchdogTimerElapsed(){var a=getWsServerState();var c=(a==0||a==1);if(G_WATCHDOG_DATA_STAMP==G_WS_SERVER_STAMP){if(!G_WATCHDOG_DATA_LOGGED){G_WATCHDOG_DATA_LOGGED=true;var b=G_RES[G_LANG]["NoDataErr"].replace(/\{0\}/g,G_WS_SERVER_URI);printDebug(G_DEBUG,b);G_LOG.add(null,G_RES[G_LANG]["WatchDog"],b,"yellow");if(!G_LOG.isCaseVisible()&&c){G_POPUP_BASIC.showBasic(b)}}}G_WATCHDOG_DATA_STAMP=G_WS_SERVER_STAMP;if(!c){if(!G_WATCHDOG_CONN_LOGGED){G_WATCHDOG_CONN_LOGGED=true;printDebug(G_DEBUG,"WatchdogConnect: Reconnect");G_LOG.add(null,G_RES[G_LANG]["WatchDog"],G_RES[G_LANG]["AutoReconnect"],null)}openWsServer()}}function writeToLog(a,c,j,g){if(typeof a=="object"&&typeof c=="number"&&typeof j=="string"){if(a&&j.length){var i=null;if(G_WS_SERVER_STAMP>0){var h=new Date();h.set_time_stamp(G_WS_SERVER_STAMP);i=h.format("isoDateTimeNorm")}var f=null;var k=a.attr("log-res-target");if(typeof k=="string"){f=((typeof G_RES[G_LANG][k]=="string")?G_RES[G_LANG][k]:null)}var e=null;if(typeof G_RES[G_LANG][j]!="undefined"){if(typeof G_RES[G_LANG][j][c]=="string"){e=G_RES[G_LANG][j][c]}}var d=a.attr("log-res-msg");if(typeof d=="string"){e=null;if(typeof G_RES[G_LANG][d][c]=="string"){e=G_RES[G_LANG][d][c]}}var b=((typeof g=="string")?g:null);if(typeof e=="string"){if(e.length){G_LOG.add(i,f,e,b)}}}}}function onBitFuncWsLog(e,d,c,b,a){if(typeof e=="object"&&typeof d=="number"&&typeof b=="string"){writeToLog(e,d,b,null)}return(true)}function onBitFuncWsRedLog(e,d,c,b,a){if(typeof e=="object"&&typeof d=="number"&&typeof b=="string"){writeToLog(e,d,b,"red")}return(true)}function onBitFuncWsYellowLog(e,d,c,b,a){if(typeof e=="object"&&typeof d=="number"&&typeof b=="string"){writeToLog(e,d,b,"yellow")}return(true)}function onBitFuncWsGreenLog(e,d,c,b,a){if(typeof e=="object"&&typeof d=="number"&&typeof b=="string"){writeToLog(e,d,b,"green")}return(true)}function initPopupBasic(){if(typeof jsPopupDialog=="function"){G_POPUP_BASIC=new jsPopupDialog("PopupBasic")}}function initFormSet(){if(typeof jsForm=="function"){G_FORM_SET=new jsForm("FormSet");G_FORM_SET.ItemOptions={log_use:{ItemType:"checkbox",DataType:"number",Allow:true}};$("#FormSetConnect").bind("click",onFormSetConnectClicked);$("#FormSetLog").bind("click",onFormSetLogClicked);G_FORM_SET.AutoCreate=true}};